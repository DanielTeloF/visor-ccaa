<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor por CCAA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 0;
    }
    .leaflet-container {
      background: #f0f0f0;
      z-index: 0;
    }
    #hud {
      position: absolute;
      z-index: 1000;
    }
    .indicator-button {
      @apply block w-full text-left px-4 py-2 rounded cursor-pointer bg-zinc-600 text-white hover:bg-zinc-500;
    }
    .indicator-button.active {
      @apply bg-blue-700 font-bold;
    }
  </style>
</head>
<body class="bg-zinc-900 text-white">
  <div id="hud" class="top-4 left-4 bg-zinc-700 p-4 rounded-xl shadow-xl w-96">
    <h2 class="text-xl font-bold mb-4">Indicadores por CCAA</h2>
    <label class="block mb-2">Categor√≠a</label>
    <select id="categorySelect" class="w-full mb-4 p-2 rounded bg-zinc-600 text-white"></select>
    <div id="indicatorList" class="space-y-2"></div>
  </div>
  
  <div id="map"></div>

  <script>
    const categories = {
      agricultura: {
        label: "üåæ Agricultura",
        fields: {
          "Superficie_agricola_%": "Superficie agr√≠cola (%)",
          "Regadio_%": "Regad√≠o (%)",
          "Cultivos_dominantes": "Cultivos dominantes",
          "Agricultura_ecol√≥gica_%": "Agricultura ecol√≥gica (%)",
          "N√∫mero_explotaciones": "N.¬∫ de explotaciones",
          "Producci√≥n_millones_agricultura": "Producci√≥n (‚Ç¨M)"
        }
      },
      ganaderia: {
        label: "üêÑ Ganader√≠a",
        fields: {
          "Bovino_cabezas": "Cabezas de bovino",
          "Porcino_cabezas": "Cabezas de porcino",
          "Ovino_cabezas": "Cabezas de ovino",
          "Caprino_cabezas": "Cabezas de caprino",
          "Avicola_cabezas": "Cabezas av√≠colas",
          "Ganader√≠a_intensiva_%": "Ganader√≠a intensiva (%)",
          "Producci√≥n_millones_ganaderia": "Producci√≥n (‚Ç¨M)"
        }
      },
      medioambiente: {
        label: "üå≥ Medioambiente",
        fields: {
          "Superficie_protegida": "Superficie protegida (%)",
          "Cobertura_forestal_%": "Cobertura forestal (%)",
          "Incendios_ult_5_a√±os": "Incendios (√∫ltimos 5 a√±os)",
          "Ha_quemadas_ult_5_a√±os": "Ha quemadas (√∫ltimos 5 a√±os)",
          "Produccion_renovable_MW": "Producci√≥n renovable (MW)",
          "Renovables_%_consumo": "% renovables consumo",
          "CO2_agro_estimado_tn": "CO‚ÇÇ agro estimado (tn)",
          "Balance_hidrico_mm": "Balance h√≠drico (mm)",
          "Indice_calidad_aire": "√çndice calidad aire"
        }
      },
      social: {
        label: "üë• Social",
        fields: {
          "Poblacion": "Poblaci√≥n",
          "Densidad_poblaci√≥n": "Densidad poblaci√≥n",
          "Porcentaje_estudios_superiores": "% estudios superiores",
          "Medicos_por_1000hab": "M√©dicos por 1000 hab",
          "Tasa de desempleo": "Tasa de desempleo",
          "Tasa_riesgo_pobreza_%": "Riesgo de pobreza (%)",
          "Precio_m2_vivienda_eur": "Precio vivienda ‚Ç¨/m¬≤"
        }
      }
    };

    const map = L.map('map').setView([40.3, -3.7], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    const categorySelect = document.getElementById('categorySelect');
    const indicatorList = document.getElementById('indicatorList');

    let geojsonLayer;
    let geojsonData;
    let selectedField = null;

    for (const cat in categories) {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = categories[cat].label;
      categorySelect.appendChild(option);
    }

    categorySelect.value = 'agricultura';

    categorySelect.addEventListener('change', () => {
      renderIndicatorButtons();
    });

    function renderIndicatorButtons() {
      indicatorList.innerHTML = '';
      const selectedCategory = categorySelect.value;
      const fields = categories[selectedCategory].fields;

      for (const key in fields) {
        const btn = document.createElement('button');
        btn.className = 'indicator-button';
        btn.dataset.field = key;
        btn.innerText = fields[key];

        btn.addEventListener('click', () => {
          document.querySelectorAll('.indicator-button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedField = key;
          updateMap();
        });

        indicatorList.appendChild(btn);
      }

      // Auto-selecciona el primero
      const firstKey = Object.keys(fields)[0];
      selectedField = firstKey;
      indicatorList.querySelector('[data-field="' + firstKey + '"]').classList.add('active');
      updateMap();
    }

    function getColorScale(min, max, value) {
      const ratio = (value - min) / (max - min);
      const startColor = [222, 235, 247];
      const endColor = [49, 130, 189];
      const r = Math.round(startColor[0] + ratio * (endColor[0] - startColor[0]));
      const g = Math.round(startColor[1] + ratio * (endColor[1] - startColor[1]));
      const b = Math.round(startColor[2] + ratio * (endColor[2] - startColor[2]));
      return `rgb(${r},${g},${b})`;
    }

    function styleFeatureFactory(min, max, field) {
      return function(feature) {
        const value = feature.properties[field];
        const fill = (typeof value === 'number') ? getColorScale(min, max, value) : '#ccc';
        return {
          fillColor: fill,
          weight: 1,
          opacity: 1,
          color: 'black',
          fillOpacity: 0.7
        };
      }
    }

    function updateMap() {
      if (!geojsonData || !selectedField) return;
      if (geojsonLayer) geojsonLayer.remove();

      const values = geojsonData.features.map(f => f.properties[selectedField]).filter(v => typeof v === 'number');
      const min = Math.min(...values);
      const max = Math.max(...values);

      geojsonLayer = L.geoJSON(geojsonData, {
        style: styleFeatureFactory(min, max, selectedField),
        onEachFeature: (feature, layer) => {
          const value = feature.properties[selectedField];
          const label = categories[categorySelect.value].fields[selectedField];
          const popup = `<strong>${feature.properties.CCAA}</strong><br>${label}: <strong>${value ?? 'N/A'}</strong>`;
          layer.bindPopup(popup);
        }
      }).addTo(map);
    }

    fetch('data/recintos_Autonomicos.geojson')
      .then(res => res.json())
      .then(data => {
        geojsonData = data;
        renderIndicatorButtons();
      });
  </script>
</body>
</html>
