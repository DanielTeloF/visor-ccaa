<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Visor por CCAA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .leaflet-container {
      background: #f0f0f0;
    }
  </style>
</head>
<body class="bg-zinc-900 text-white">
  <div class="absolute top-4 left-4 z-10 bg-zinc-800 p-4 rounded-xl shadow-xl w-80">
    <h2 class="text-xl font-bold mb-4">Indicadores por CCAA</h2>
    <label class="block mb-2">Categor√≠a</label>
    <select id="categorySelect" class="w-full mb-4 p-2 rounded bg-zinc-700 text-white"></select>

    <label class="block mb-2">Indicador</label>
    <select id="indicatorSelect" class="w-full p-2 rounded bg-zinc-700 text-white"></select>
  </div>
  
  <div id="map"></div>

  <script>
    const categories = {
      agricultura: {
        label: "üåæ Agricultura",
        fields: {
          "Superficie_agricola_%": "Superficie agr√≠cola (%)",
          "Regadio_%": "Regad√≠o (%)",
          "Cultivos_dominantes": "Cultivos dominantes",
          "Agricultura_ecol√≥gica_%": "Agricultura ecol√≥gica (%)",
          "N√∫mero_explotaciones": "N.¬∫ de explotaciones",
          "Producci√≥n_millones_agricultura": "Producci√≥n (‚Ç¨M)"
        }
      },
      ganaderia: {
        label: "üêÑ Ganader√≠a",
        fields: {
          "Bovino_cabezas": "Cabezas de bovino",
          "Porcino_cabezas": "Cabezas de porcino",
          "Ovino_cabezas": "Cabezas de ovino",
          "Caprino_cabezas": "Cabezas de caprino",
          "Avicola_cabezas": "Cabezas av√≠colas",
          "Ganader√≠a_intensiva_%": "Ganader√≠a intensiva (%)",
          "Producci√≥n_millones_ganaderia": "Producci√≥n (‚Ç¨M)"
        }
      },
      medioambiente: {
        label: "üå≥ Medioambiente",
        fields: {
          "Superficie_protegida": "Superficie protegida (%)",
          "Cobertura_forestal_%": "Cobertura forestal (%)",
          "Incendios_ult_5_a√±os": "Incendios (√∫ltimos 5 a√±os)",
          "Ha_quemadas_ult_5_a√±os": "Ha quemadas (√∫ltimos 5 a√±os)",
          "Produccion_renovable_MW": "Producci√≥n renovable (MW)",
          "Renovables_%_consumo": "% renovables consumo",
          "CO2_agro_estimado_tn": "CO‚ÇÇ agro estimado (tn)",
          "Balance_hidrico_mm": "Balance h√≠drico (mm)",
          "Indice_calidad_aire": "√çndice calidad aire"
        }
      },
      social: {
        label: "üë• Social",
        fields: {
          "Poblacion": "Poblaci√≥n",
          "Densidad_poblaci√≥n": "Densidad poblaci√≥n",
          "Porcentaje_estudios_superiores": "% estudios superiores",
          "Medicos_por_1000hab": "M√©dicos por 1000 hab",
          "Tasa de desempleo": "Tasa de desempleo",
          "Tasa_riesgo_pobreza_%": "Riesgo de pobreza (%)",
          "Precio_m2_vivienda_eur": "Precio vivienda ‚Ç¨/m¬≤"
        }
      }
    };

    const map = L.map('map').setView([40.3, -3.7], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const categorySelect = document.getElementById('categorySelect');
    const indicatorSelect = document.getElementById('indicatorSelect');

    let geojsonLayer;
    let geojsonData;

    // Llenar el selector de categor√≠as
    for (const cat in categories) {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = categories[cat].label;
      categorySelect.appendChild(option);
    }

    categorySelect.addEventListener('change', () => {
      updateIndicatorOptions();
      updateMap();
    });

    indicatorSelect.addEventListener('change', updateMap);

    function updateIndicatorOptions() {
      indicatorSelect.innerHTML = '';
      const selectedCategory = categorySelect.value;
      const fields = categories[selectedCategory].fields;
      for (const key in fields) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = fields[key];
        indicatorSelect.appendChild(opt);
      }
    }

    function getColor(value) {
      return value > 75 ? '#084081' :
             value > 50 ? '#0868ac' :
             value > 25 ? '#2b8cbe' :
             value > 10 ? '#4eb3d3' :
             value >= 0 ? '#7bccc4' : '#d0d1e6';
    }

    function styleFeature(feature) {
      const field = indicatorSelect.value;
      const value = feature.properties[field];
      return {
        fillColor: getColor(value),
        weight: 1,
        opacity: 1,
        color: 'black',
        fillOpacity: 0.7
      };
    }

    function updateMap() {
      if (!geojsonData) return;
      if (geojsonLayer) geojsonLayer.remove();

      const selectedField = indicatorSelect.value;
      const selectedLabel = indicatorSelect.options[indicatorSelect.selectedIndex].textContent;

      geojsonLayer = L.geoJSON(geojsonData, {
        style: styleFeature,
        onEachFeature: (feature, layer) => {
          const value = feature.properties[selectedField];
          const label = `<strong>${feature.properties.CCAA}</strong><br>${selectedLabel}: <strong>${value ?? 'N/A'}</strong>`;
          layer.bindPopup(label);
        }
      }).addTo(map);
    }

    // Cargar el GeoJSON
    fetch('data/recintos_Autonomicos.geojson')
      .then(res => res.json())
      .then(data => {
        geojsonData = data;
        updateIndicatorOptions();
        updateMap();
      });
  </script>
</body>
</html>
